name: Build Android ARM64 Only

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - 'flutter/**'
      - 'libs/**'
      - '**.dart'
      - '**.rs'

env:
  RUST_VERSION: "1.75"
  CARGO_NDK_VERSION: "3.1.2"
  ANDROID_FLUTTER_VERSION: "3.24.5"
  NDK_VERSION: "r27c"
  VERSION: "1.4.4"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"

jobs:
  generate-bridge:
    uses: ./.github/workflows/bridge.yml

  build-android-arm64:
    name: Build Android ARM64 APK
    needs: [generate-bridge]
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: true
      
      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
               clang cmake curl git \
               g++ g++-multilib \
               libclang-dev \
               nasm ninja-build \
               openjdk-17-jdk-headless \
               pkg-config python3 python3-pip tar unzip wget
      
      - name: Install vcpkg manually
        id: install-vcpkg
        run: |
          echo "Installing vcpkg..."
          VCPKG_ROOT="/opt/vcpkg"
          echo "VCPKG_ROOT=${VCPKG_ROOT}" >> $GITHUB_ENV
          
          # åˆ›å»ºç›®å½•
          sudo mkdir -p /opt
          sudo chmod 777 /opt
          
          # å…‹éš† vcpkg
          cd /opt
          git clone https://github.com/microsoft/vcpkg.git
          cd vcpkg
          
          # åˆ‡æ¢åˆ°æŒ‡å®šæäº¤
          git checkout ${{ env.VCPKG_COMMIT_ID }}
          
          # å¼•å¯¼ vcpkg
          ./bootstrap-vcpkg.sh -disableMetrics
          
          echo "VCPKG installed at: $(pwd)"
          echo "vcpkg path: $(pwd)/vcpkg"
          
          # æ·»åŠ åˆ° PATH
          echo "$(pwd)" >> $GITHUB_PATH
      
      - name: Install flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.ANDROID_FLUTTER_VERSION }}
      
      - name: Restore bridge files
        uses: actions/download-artifact@master
        with:
          name: bridge-artifact
          path: ./
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: "rustfmt"
      
      - name: Build Android dependencies - ç®€åŒ–ç‰ˆ
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          VCPKG_ROOT: /opt/vcpkg
        run: |
          echo "VCPKG_ROOT: $VCPKG_ROOT"
          echo "vcpkg executable: $VCPKG_ROOT/vcpkg"
          ls -la $VCPKG_ROOT/ || true
          
          echo "ğŸ”§ å®‰è£… arm64-android ä¾èµ–..."
          
          # ç›´æ¥ä½¿ç”¨ vcpkg å®‰è£…ä¾èµ–
          $VCPKG_ROOT/vcpkg install \
            --triplet arm64-android \
            ffmpeg \
            libvpx \
            libyuv \
            opus \
            x264 \
            x265
          
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
      
      - name: Build Rust library for ARM64
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          echo "ğŸ”¨ æ„å»º ARM64 Rust åº“..."
          
          # æ·»åŠ ç›®æ ‡æ¶æ„
          rustup target add aarch64-linux-android
          
          # å®‰è£… cargo-ndk
          cargo install cargo-ndk --version ${{ env.CARGO_NDK_VERSION }}
          
          echo "è®¾ç½®ç¯å¢ƒå˜é‡..."
          export CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang"
          export CC_aarch64_linux_android="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang"
          export CXX_aarch64_linux_android="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android34-clang++"
          
          echo "æ„å»º librustdesk.so..."
          cd libs
          cargo ndk \
            --target aarch64-linux-android \
            --platform 34 \
            -- build --release --features flutter,hwcodec
          
          # æ£€æŸ¥æ˜¯å¦æ„å»ºæˆåŠŸ
          if [ -f "../target/aarch64-linux-android/release/liblibrustdesk.so" ]; then
            echo "âœ… Rust åº“æ„å»ºæˆåŠŸ"
            # å¤åˆ¶åˆ° Flutter ç›®å½•
            mkdir -p ../flutter/android/app/src/main/jniLibs/arm64-v8a
            cp ../target/aarch64-linux-android/release/liblibrustdesk.so \
               ../flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
            ls -la ../flutter/android/app/src/main/jniLibs/arm64-v8a/
          else
            echo "âŒ Rust åº“æœªæ‰¾åˆ°!"
            echo "æŸ¥æ‰¾æ–‡ä»¶..."
            find ../target -name "*.so" -type f | head -20
            exit 1
          fi
      
      - name: Build Flutter APK
        env:
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          export PATH=$JAVA_HOME/bin:$PATH
          
          echo "ğŸ“± æ„å»º Flutter APK..."
          
          # å¤åˆ¶å¿…è¦çš„å…±äº«åº“
          CXX_SHARED="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/libc++_shared.so"
          if [ -f "$CXX_SHARED" ]; then
            mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a
            cp "$CXX_SHARED" flutter/android/app/src/main/jniLibs/arm64-v8a/
            echo "å¤åˆ¶ libc++_shared.so"
          fi
          
          # é…ç½® Gradle ä½¿ç”¨æ›´å¤šå†…å­˜
          if [ -f "flutter/android/gradle.properties" ]; then
            echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g" >> flutter/android/gradle.properties
          fi
          
          # è¿›å…¥ Flutter ç›®å½•
          cd flutter
          
          # æ¸…ç†å¹¶è·å–ä¾èµ–
          flutter clean
          flutter pub get
          
          echo "Flutter åŒ»ç”Ÿæ£€æŸ¥..."
          flutter doctor -v
          
          # æ„å»º APKï¼ˆä½¿ç”¨ debug ç­¾åï¼‰
          echo "å¼€å§‹æ„å»º APK..."
          flutter build apk --release \
            --target-platform android-arm64 \
            --no-tree-shake-icons
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          echo "æ„å»ºè¾“å‡ºæ–‡ä»¶:"
          ls -la build/app/outputs/flutter-apk/
          
          # é‡å‘½åæ–‡ä»¶
          APK_FILE="build/app/outputs/flutter-apk/app-arm64-v8a-release.apk"
          if [ -f "$APK_FILE" ]; then
            FINAL_APK="../rustdesk-${{ env.VERSION }}-arm64.apk"
            mv "$APK_FILE" "$FINAL_APK"
            echo "âœ… APK åˆ›å»ºæˆåŠŸ: $(basename $FINAL_APK)"
            echo "æ–‡ä»¶å¤§å°: $(du -h $FINAL_APK | cut -f1)"
          else
            echo "âŒ APK æ–‡ä»¶æœªæ‰¾åˆ°!"
            echo "å°è¯•æŸ¥æ‰¾å…¶ä»– APK æ–‡ä»¶..."
            find build/app/outputs -name "*.apk" -type f
            exit 1
          fi
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-arm64
          path: rustdesk-${{ env.VERSION }}-arm64.apk
          retention-days: 7
        if: success()
      
      - name: Build summary
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ“Š æ„å»ºæ€»ç»“"
          echo "========================================"
          echo "âœ… å·¥ä½œæµ: Build Android ARM64 Only"
          echo "ğŸ“± æ¶æ„: arm64-v8a (ç°ä»£å®‰å“æ‰‹æœº)"
          echo "ğŸ•’ çŠ¶æ€: ${{ job.status }}"
          echo "========================================"
