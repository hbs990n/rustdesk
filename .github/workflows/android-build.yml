name: Build Android ARM64 Only

on:
  workflow_dispatch:  # æ‰‹åŠ¨è¿è¡ŒæŒ‰é’®
  push:
    branches: [main, master]
    paths:
      - 'flutter/**'
      - 'libs/**'
      - '**.dart'
      - '**.rs'

env:
  RUST_VERSION: "1.75"
  CARGO_NDK_VERSION: "3.1.2"
  ANDROID_FLUTTER_VERSION: "3.24.5"
  NDK_VERSION: "r27c"
  VERSION: "1.4.4"

jobs:
  generate-bridge:
    uses: ./.github/workflows/bridge.yml

  build-android-arm64:
    name: Build Android ARM64 APK
    needs: [generate-bridge]
    runs-on: ubuntu-24.04
    timeout-minutes: 30  # å•æ¶æ„åº”è¯¥æ›´å¿«
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: true
      
      - name: Setup vcpkg
        run: |
          echo "VCPKG_ROOT=/opt/artifacts/vcpkg" >> $GITHUB_ENV
          mkdir -p /opt/artifacts
      
      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
               clang cmake \
               g++ g++-multilib \
               libclang-dev \
               nasm ninja-build \
               openjdk-17-jdk-headless \
               pkg-config wget
      
      - name: Install flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.ANDROID_FLUTTER_VERSION }}
      
      - name: Patch flutter (if needed)
        run: |
          flutter --version
          # å¯é€‰ï¼šåº”ç”¨è¡¥ä¸
          if [ -f ".github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff" ]; then
            cd $(dirname $(dirname $(which flutter)))
            [[ "3.24.5" == "${{env.ANDROID_FLUTTER_VERSION}}" ]] && git apply "${{ github.workspace }}/.github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff"
          fi
      
      - name: Restore bridge files
        uses: actions/download-artifact@master
        with:
          name: bridge-artifact
          path: ./
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: "rustfmt"
      
      - name: Build Android dependencies (arm64-v8a)
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          VCPKG_ROOT: /opt/artifacts/vcpkg
        run: |
          echo "Building dependencies for arm64-v8a (æ‰‹æœºç‰ˆ)"
          
          # æ£€æŸ¥ä¾èµ–æ„å»ºè„šæœ¬
          if [ -f "./flutter/build_android_deps.sh" ]; then
            echo "Found build_android_deps.sh script"
            chmod +x ./flutter/build_android_deps.sh
            ./flutter/build_android_deps.sh "arm64-v8a"
          else
            echo "Warning: build_android_deps.sh not found, trying alternative approach"
            # å°è¯•ç›´æ¥æ„å»ºvcpkgä¾èµ–
            if [ -d "/opt/artifacts/vcpkg" ]; then
              cd /opt/artifacts/vcpkg
              ./vcpkg install --triplet arm64-android
            fi
          fi
      
      - name: Build Rust library for ARM64
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          echo "Building Rust library for ARM64 (aarch64-linux-android)"
          
          # æ·»åŠ ç›®æ ‡æ¶æ„
          rustup target add aarch64-linux-android
          
          # å®‰è£… cargo-ndk
          cargo install cargo-ndk --version ${{ env.CARGO_NDK_VERSION }}
          
          # æ„å»ºåº“æ–‡ä»¶
          echo "Building librustdesk.so..."
          cd libs
          cargo ndk -t aarch64-linux-android build --release --features flutter,hwcodec
          
          # æ£€æŸ¥æ˜¯å¦æ„å»ºæˆåŠŸ
          if [ -f "../target/aarch64-linux-android/release/liblibrustdesk.so" ]; then
            echo "Rust library built successfully"
            # å¤åˆ¶åˆ° Flutter ç›®å½•
            mkdir -p ../flutter/android/app/src/main/jniLibs/arm64-v8a
            cp ../target/aarch64-linux-android/release/liblibrustdesk.so \
               ../flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
          else
            echo "Error: Rust library not found!"
            ls -la ../target/aarch64-linux-android/release/ || true
            exit 1
          fi
      
      - name: Build Flutter APK
        env:
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          export PATH=$JAVA_HOME/bin:$PATH
          
          echo "Building Flutter APK..."
          
          # å¤åˆ¶å¿…è¦çš„å…±äº«åº“
          if [ -f "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/libc++_shared.so" ]; then
            mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a
            cp "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/libc++_shared.so" \
               flutter/android/app/src/main/jniLibs/arm64-v8a/
          fi
          
          # è¿›å…¥ Flutter ç›®å½•å¹¶æ„å»º
          cd flutter
          
          # è·å–ä¾èµ–
          flutter pub get
          
          # æ„å»º APK
          flutter build apk --release --target-platform android-arm64 --split-per-abi
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          echo "Build output files:"
          ls -la build/app/outputs/flutter-apk/
          
          # é‡å‘½åæ–‡ä»¶
          if [ -f "build/app/outputs/flutter-apk/app-arm64-v8a-release.apk" ]; then
            mv build/app/outputs/flutter-apk/app-arm64-v8a-release.apk \
               ../rustdesk-${{ env.VERSION }}-arm64.apk
            echo "APK created: rustdesk-${{ env.VERSION }}-arm64.apk"
          else
            echo "Error: APK file not found!"
            exit 1
          fi
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-arm64
          path: rustdesk-${{ env.VERSION }}-arm64.apk
          retention-days: 7
      
      - name: Display APK info
        run: |
          echo "ğŸ“± Android ARM64 APK æ„å»ºå®Œæˆ!"
          echo "æ–‡ä»¶: rustdesk-${{ env.VERSION }}-arm64.apk"
          echo "æ¶æ„: arm64-v8a (ç°ä»£å®‰å“æ‰‹æœº)"
          echo "å¤§å°:" $(du -h rustdesk-${{ env.VERSION }}-arm64.apk | cut -f1)
