name: Build Android ARM64 (Clean Disk)

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - 'flutter/**'
      - 'libs/**'

env:
  RUST_VERSION: "1.75"
  CARGO_NDK_VERSION: "3.1.2"
  ANDROID_FLUTTER_VERSION: "3.24.5"
  NDK_VERSION: "r27c"
  VERSION: "1.4.4"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"

jobs:
  generate-bridge:
    uses: ./.github/workflows/bridge.yml

  build-android-arm64:
    name: Build Android ARM64 APK
    needs: [generate-bridge]
    runs-on: ubuntu-24.04
    timeout-minutes: 35
    
    steps:
      # 第一步：清理磁盘空间（关键！）
      - name: Clean disk space before build
        run: |
          echo "=== 清理磁盘空间 ==="
          echo "清理前磁盘使用情况："
          df -h
          
          # 清理APT缓存
          sudo apt-get clean
          sudo apt-get autoclean
          
          # 删除不必要的包
          sudo apt-get autoremove -y
          
          # 清理临时文件
          sudo rm -rf /tmp/*
          sudo rm -rf /var/tmp/*
          
          # 清理日志文件（保留最近7天）
          sudo find /var/log -type f -name "*.log" -mtime +7 -delete
          sudo find /var/log -type f -name "*.gz" -delete
          
          # 清理Docker镜像（如果有）
          if command -v docker &> /dev/null; then
            sudo docker system prune -af 2>/dev/null || true
          fi
          
          # 清理Flutter缓存（如果存在）
          rm -rf ~/.pub-cache 2>/dev/null || true
          
          echo "清理后磁盘使用情况："
          df -h
      
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: true
      
      - name: Setup vcpkg with cache
        uses: lukka/run-vcpkg@v11
        id: setup-vcpkg
        with:
          vcpkgDirectory: /opt/artifacts/vcpkg
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}
          doNotCache: false
      
      - name: Install minimal tools only
        run: |
          echo "=== 安装最小化工具集 ==="
          sudo apt-get update
          # 只安装必要的包
          sudo apt-get install -y \
               clang cmake \
               g++ \
               libclang-dev \
               nasm ninja-build \
               openjdk-17-jdk-headless \
               pkg-config
      
      - name: Install flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.ANDROID_FLUTTER_VERSION }}
          cache: true
          cache-key: flutter-${{ env.ANDROID_FLUTTER_VERSION }}
      
      - name: Restore bridge files
        uses: actions/download-artifact@master
        with:
          name: bridge-artifact
          path: ./
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: "rustfmt"
      
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: rustdesk-android
          key: aarch64-linux-android
      
      - name: Set environment variables
        run: |
          echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "VCPKG_ROOT=/opt/artifacts/vcpkg" >> $GITHUB_ENV
      
      - name: Clean Rust target before build
        run: |
          echo "清理Rust target目录..."
          # 只保留release目录，删除其他构建
          if [ -d "target" ]; then
            find target -name "debug" -type d -exec rm -rf {} + 2>/dev/null || true
            find target -name "*.rlib" -delete 2>/dev/null || true
            find target -name "*.d" -delete 2>/dev/null || true
          fi
      
      - name: Install cargo-ndk
        run: |
          echo "安装 cargo-ndk..."
          # 尝试使用预编译版本或从源码编译
          cargo install cargo-ndk --version ${{ env.CARGO_NDK_VERSION }} --locked --root /tmp/cargo-install
          export PATH="/tmp/cargo-install/bin:$PATH"
          cargo-ndk --version
      
      - name: Build Android dependencies
        run: |
          echo "构建安卓依赖..."
          chmod +x ./flutter/build_android_deps.sh
          ./flutter/build_android_deps.sh "arm64-v8a"
      
      - name: Build Rust library
        run: |
          echo "构建Rust库..."
          rustup target add aarch64-linux-android
          
          # 清理旧构建
          rm -rf target/aarch64-linux-android/release/build 2>/dev/null || true
          
          chmod +x ./flutter/ndk_arm64.sh
          ./flutter/ndk_arm64.sh
          
          if [ -f "target/aarch64-linux-android/release/liblibrustdesk.so" ]; then
            mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a
            cp target/aarch64-linux-android/release/liblibrustdesk.so \
               flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
          fi
      
      - name: Clean intermediate files before Flutter build
        run: |
          echo "清理中间文件..."
          # 清理vcpkg构建文件
          rm -rf /opt/artifacts/vcpkg/buildtrees/*/src 2>/dev/null || true
          
          # 显示剩余空间
          echo "当前磁盘空间："
          df -h
          echo "home目录使用："
          du -sh ~/ 2>/dev/null || true
      
      - name: Build Flutter APK
        env:
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
        run: |
          export PATH=$JAVA_HOME/bin:$PATH
          
          cd flutter
          
          # 最小化构建
          flutter build apk --release \
            --target-platform android-arm64 \
            --split-per-abi \
            --no-tree-shake-icons \
            --shrink
          
          if [ -f "build/app/outputs/flutter-apk/app-arm64-v8a-release.apk" ]; then
            mv build/app/outputs/flutter-apk/app-arm64-v8a-release.apk \
               ../rustdesk-${{ env.VERSION }}-arm64.apk
          fi
      
      - name: Clean after build
        run: |
          echo "构建后清理..."
          # 删除vcpkg源码
          rm -rf /opt/artifacts/vcpkg/buildtrees 2>/dev/null || true
          
          # 删除Rust构建缓存
          rm -rf target/aarch64-linux-android/release/build 2>/dev/null || true
          rm -rf target/aarch64-linux-android/release/deps 2>/dev/null || true
          
          # 删除Flutter构建缓存
          rm -rf flutter/build/app/intermediates 2>/dev/null || true
          
          echo "最终磁盘空间："
          df -h
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: rustdesk-android-arm64
          path: rustdesk-${{ env.VERSION }}-arm64.apk
          retention-days: 3  # 减少保留时间
