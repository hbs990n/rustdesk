name: Build Android ARM64 (Final)

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - 'flutter/**'
      - 'libs/**'

env:
  RUST_VERSION: "1.75"
  CARGO_NDK_VERSION: "3.1.2"
  ANDROID_FLUTTER_VERSION: "3.24.5"
  NDK_VERSION: "r27c"
  VERSION: "1.4.4"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"

jobs:
  generate-bridge:
    uses: ./.github/workflows/bridge.yml

  build-android-arm64:
    name: Build Android ARM64 APK
    needs: [generate-bridge]
    runs-on: ubuntu-24.04
    timeout-minutes: 45
    
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: ${{ env.NDK_VERSION }}
          add-to-path: true
      
      - name: Setup vcpkg with cache
        uses: lukka/run-vcpkg@v11
        id: setup-vcpkg
        with:
          vcpkgDirectory: /opt/artifacts/vcpkg
          vcpkgGitCommitId: ${{ env.VCPKG_COMMIT_ID }}
          doNotCache: false
      
      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
               clang cmake \
               g++ \
               libclang-dev \
               nasm ninja-build \
               openjdk-17-jdk-headless \
               pkg-config wget
      
      - name: Install flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.ANDROID_FLUTTER_VERSION }}
          cache: true
      
      - name: Restore bridge files
        uses: actions/download-artifact@master
        with:
          name: bridge-artifact
          path: ./
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: "rustfmt"
      
      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: rustdesk-android-final
          key: aarch64-${{ env.RUST_VERSION }}
      
      - name: Set environment variables
        run: |
          echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "VCPKG_ROOT=/opt/artifacts/vcpkg" >> $GITHUB_ENV
          echo "ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ"
      
      - name: Install cargo-ndk
        run: |
          echo "å®‰è£… cargo-ndk..."
          cargo install cargo-ndk --version ${{ env.CARGO_NDK_VERSION }} --locked
          echo "âœ… cargo-ndk å®‰è£…æˆåŠŸ"
          # éªŒè¯å®‰è£…
          cargo ndk --version
      
      - name: Build Android dependencies
        run: |
          echo "æ„å»ºå®‰å“ä¾èµ–..."
          echo "æ£€æŸ¥vcpkg: $VCPKG_ROOT/vcpkg"
          ls -la $VCPKG_ROOT/vcpkg || echo "vcpkgæœªæ‰¾åˆ°"
          
          chmod +x ./flutter/build_android_deps.sh
          ./flutter/build_android_deps.sh "arm64-v8a"
          echo "âœ… ä¾èµ–æ„å»ºå®Œæˆ"
      
      - name: Build Rust library (ä¿®å¤è°ƒç”¨æ–¹å¼)
        run: |
          echo "æ„å»ºRuståº“..."
          
          # æ·»åŠ ç›®æ ‡æ¶æ„
          rustup target add aarch64-linux-android
          
          # æ–¹æ³•1: ä½¿ç”¨cargo ndkå‘½ä»¤ï¼ˆæ­£ç¡®æ–¹å¼ï¼‰
          echo "æ–¹æ³•1: ä½¿ç”¨ cargo ndk å‘½ä»¤"
          cd libs
          cargo ndk --platform 21 --target aarch64-linux-android build --release --features flutter,hwcodec
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ -f "../target/aarch64-linux-android/release/liblibrustdesk.so" ]; then
            echo "âœ… Ruståº“æ„å»ºæˆåŠŸ"
            # å¤åˆ¶åˆ°Flutterç›®å½•
            mkdir -p ../flutter/android/app/src/main/jniLibs/arm64-v8a
            cp ../target/aarch64-linux-android/release/liblibrustdesk.so \
               ../flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
          else
            echo "âŒ æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2..."
            # æ–¹æ³•2: ç›´æ¥è¿è¡Œndk_arm64.shè„šæœ¬
            cd ..
            chmod +x ./flutter/ndk_arm64.sh
            ./flutter/ndk_arm64.sh
            
            if [ -f "target/aarch64-linux-android/release/liblibrustdesk.so" ]; then
              echo "âœ… æ–¹æ³•2æˆåŠŸ"
              mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a
              cp target/aarch64-linux-android/release/liblibrustdesk.so \
                 flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
            else
              echo "âŒ æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥"
              exit 1
            fi
          fi
          
          echo "åº“æ–‡ä»¶ä½ç½®:"
          ls -lh flutter/android/app/src/main/jniLibs/arm64-v8a/
      
      - name: Prepare for Flutter build
        run: |
          echo "å‡†å¤‡Flutteræ„å»º..."
          
          # å¤åˆ¶libc++_shared.so
          if [ -f "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/libc++_shared.so" ]; then
            mkdir -p flutter/android/app/src/main/jniLibs/arm64-v8a
            cp "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/libc++_shared.so" \
               flutter/android/app/src/main/jniLibs/arm64-v8a/
          fi
          
          # è®¾ç½®Gradleå†…å­˜
          echo "org.gradle.jvmargs=-Xmx4096m -Dfile.encoding=UTF-8" >> flutter/android/gradle.properties
      
      - name: Build Flutter APK
        env:
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
        run: |
          export PATH=$JAVA_HOME/bin:$PATH
          
          echo "æ„å»ºFlutter APK..."
          
          cd flutter
          
          # æ¸…ç†å¹¶è·å–ä¾èµ–
          flutter clean
          flutter pub get
          
          # æ„å»ºAPK
          flutter build apk --release \
            --target-platform android-arm64 \
            --split-per-abi \
            --no-tree-shake-icons
          
          # æ£€æŸ¥ç»“æœ
          echo "æ„å»ºè¾“å‡º:"
          ls -la build/app/outputs/flutter-apk/
          
          # é‡å‘½åAPK
          APK_SOURCE="build/app/outputs/flutter-apk/app-arm64-v8a-release.apk"
          APK_DEST="../rustdesk-${{ env.VERSION }}-arm64.apk"
          
          if [ -f "$APK_SOURCE" ]; then
            mv "$APK_SOURCE" "$APK_DEST"
            echo "âœ… APKæ„å»ºæˆåŠŸ: $(basename $APK_DEST)"
            echo "æ–‡ä»¶å¤§å°: $(du -h $APK_DEST | cut -f1)"
          else
            echo "âŒ APKæ–‡ä»¶æœªæ‰¾åˆ°"
            # å°è¯•æŸ¥æ‰¾å…¶ä»–APKæ–‡ä»¶
            find build/app/outputs -name "*.apk" -type f
            exit 1
          fi
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-arm64
          path: rustdesk-${{ env.VERSION }}-arm64.apk
          retention-days: 7
      
      - name: Display success message
        if: success()
        run: |
          echo ""
          echo "ğŸ‰ğŸ‰ğŸ‰ æ„å»ºæˆåŠŸï¼ ğŸ‰ğŸ‰ğŸ‰"
          echo "========================================"
          echo "ğŸ“± Android ARM64 APK å·²ç”Ÿæˆ"
          echo "ğŸ“¦ æ–‡ä»¶: rustdesk-${{ env.VERSION }}-arm64.apk"
          echo "ğŸ—ï¸  æ¶æ„: arm64-v8a (ç°ä»£å®‰å“æ‰‹æœº)"
          echo "ğŸ“¥ å¯åœ¨Artifactsä¸­ä¸‹è½½"
          echo "========================================"
